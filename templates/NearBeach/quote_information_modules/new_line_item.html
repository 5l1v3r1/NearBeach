{% csrf_token %}
{% load static %}
<link rel="stylesheet" href="{% static 'NearBeach/javascript/chosen-js/chosen.css' %}">
<link rel="stylesheet" href="{% static 'NearBeach/javascript/chosen-js/docsupport/prism.css' %}">

<script>
    function change_discount_choice() {
        /* Updates the discount type */
        if ($("#id_discount_choice").val() == "Percentage") {
            //Show the percentage
            $("#id_discount_percent").css("display","");
            $("#id_discount_amount").css("display","none");
        } else {
            //Show the amount
            $("#id_discount_percent").css("display","none");
            $("#id_discount_amount").css("display","");
        }
    }

    function update_total() {
        //Get and declare variables
        var total_price = parseFloat($("#id_quantity").val()) * parseFloat($("#id_product_price").val());
        var discount_price = 0;
        var tax_amount = 0;

        if ($("#id_discount_choice").val() == "Percentage") {
            //Apply the percentage to the total_price to get $$$ off
            discount_price = total_price - (($("#id_discount_percent").val()/100)*total_price);
        } else {
            discount_price = total_price - $("#id_discount_amount").val();
        }

        //Show the amount of tax
        if ($("#id_tax").val() == "") {
            //There is no tax applied. ZERO
            tax_amount = 0;
            $("#id_tax_amount").val(0);
        } else {
            //There is a tax amount.
            tax_amount = ($("#id_tax").val()/100)*discount_price;
            $("#id_tax_amount").val(tax_amount);
        }

        //Calculate the total
        $("#id_total").val(discount_price + tax_amount);

        //Determine if user can submit the line item
        if (isNaN($("#id_total").val()) == false) {
            $("#submit_line_item").prop("disabled",false);
        } else {
            $("#submit_line_item").prop("disabled",true);
        }

    }


</script>

<table id="product">
    <tr class="header">
        <td width="70%" colspan="2">Add Product/Service</td>
        <td class="quantity" width="5%" style="display: none;">Quantity</td>
        <td width="20%" style="display: none;">Cost</td>
    </tr>
    <tr>
        <td colspan="2">{{ new_line_item_form.products_and_services }}</td>
        <td class="quantity" style="display: none;">{{ new_line_item_form.quantity }}</td>
        <td style="display: none;">{{ new_line_item_form.product_cost }}</td>
    </tr>
    <tr>
        <td colspan="4" style="display: none;">{{ new_line_item_form.product_description }}</td>
    </tr>
</table>
<table id="product_costing" style="display: none;">
    <tr>
        <td>Price per Unit</td>
        <td>Discount</td>
        <td>Tax</td>
        <td>Total</td>
    </tr>
    <tr>
        <td>{{ new_line_item_form.product_price }}</td>
        <td>{{ new_line_item_form.discount_percent }}{{ new_line_item_form.discount_amount }} {{ new_line_item_form.discount_choice }}</td>
        <td>{{ new_line_item_form.tax }}{{ new_line_item_form.tax_amount }}</td>
        <td>{{ new_line_item_form.total }}</td>
    </tr>
    <tr>
        <td colspan="4">{{ new_line_item_form.product_note }}</td>
    </tr>
    <tr>
        <td colspan="4"><input id="submit_line_item" type="submit" disabled value="Submit New Line Item"></td>
    </tr>
</table>

<script type="text/javascript" src="{% static 'NearBeach/javascript/chosen-js/chosen.jquery.js' %}"></script>
<script type="text/javascript" src="{% static 'NearBeach/javascript/chosen-js/docsupport/prism.js' %}"></script>
<script type="text/javascript" src="{% static 'NearBeach/javascript/chosen-js/docsupport/init.js' %}"></script>

<script>
    /*
    Method
    ~~~~~~
    1.) When the user changes the product/service the system will determine which one it is
    2.) It will apply the default values and hide unwanted fields
    3.) If it is a product, it will extract the base values from the database
     */
    $("#id_product_or_service").on('change', function(evt, params) {
        var label = $(this.options[this.selectedIndex]).closest('optgroup').prop('label');
        var product_id = $(this.options[this.selectedIndex]).val();


        if (label == 'Products') {
            $("#product").find("td").css("display", "");
            $("#product_costing").css("display","");

            //Get the product information
            $.getJSON('/lookup_product/'+product_id,function(data){
               /*
               We are now looking up the product information from the JSON function.
               We now have to look into each element of the JSON (even though there
               is only one), to extract the values inside.
               */
               $.each(data, function(i,f) {
                   /*
                   Now we can extract the required information using the following code
                   f.fields.product_or_service
                   */
                   $("#id_product_cost").val(f.fields.product_cost);
                   $("#id_product_description").val(f.fields.product_description);
                   $("#id_product_price").val(f.fields.product_price);

                   /*
                   If the product discription does not exist, make it hide
                   */
                   if (f.fields.product_description == "") {
                        $("#id_product_description").css("display","none");
                        $("#id_product_description").prop("readonly","true");
                   } else {
                       $("#id_product_description").css("display","");
                   }
               });
                update_total();
            });
        } else {
            /*
            Well, this is exciting. Someone has order in services.
             */
            $("#id_product_description").prop("readonly","false");
            $(".quantity").css("display","none")
        }
    })


    //Submitting a new line item
    $("#new_line_item").on('submit', function(e) {
       e.preventDefault();
       $.ajax({
           type: "POST",
           url: '/quote_new_line_item/{{ quote_id }}/',
           data: $(this).serialize(),
           success: function() {
               alert("YAY!");
           },
           error: function() {
               alert("There has been an error submitting the new line item");
           }
       })
    });
</script>