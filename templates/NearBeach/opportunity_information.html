{% extends "./template.html" %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'NearBeach/javascript/chosen-js/chosen.css' %}">
<link rel="stylesheet" href="{% static 'NearBeach/javascript/chosen-js/docsupport/prism.css' %}">


    <script type="text/javascript" src="{% static 'NearBeach/javascript/csrf_finder.js' %}"></script>
    <script type="text/javascript" src="{% static 'NearBeach/javascript/permissions.js' %}"></script>


<body onload="on_page_load()">
    <form id="opportunity_information" action="{% url 'opportunity_information' opportunity_id %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <h2>Opportunity Information</h2>
        <div id="save_state"></div>
        <ul>
            <li>{{ opportunity_information_form.opportunity_name }}</li>
            <li>{{ opportunity_information_form.opportunity_description }}</li>
            <li>Lead Source: {{ opportunity_results.lead_source_id }}</li>
            <li>Organisation: {{ opportunity_results.organisations_id }}</li>
            <li>
                Customer: <select>
                    <option value="">-------</option>
                    {% for row in customer_results %}
                        {% if row.customer_id == opportunity_results.customer_id.customer_id %}
                            <option value="{{ row.customer_id }}" selected>
                        {% else %}
                            <option value="{{ row.customer_id }}">
                        {% endif %}
                        {{ row.customer_first_name }} {{ row.customer_last_name }}</option>
                    {% endfor %}
                </select>
            </li>
            <li>
                Opportunity Amount: {{ opportunity_information_form.currency_id }}
                {{ opportunity_information_form.opportunity_amount }}
                {{ opportunity_information_form.amount_type_id }}
            </li>
            <li>Time Zone: {{ timezone }}</li>
            <li>Opportunity Expected Close Date: {{ opportunity_information_form.finish_date_year }}
                {{ opportunity_information_form.finish_date_month }}
                {{ opportunity_information_form.finish_date_day }}
                @ {{ opportunity_information_form.finish_date_hour }}:{{ opportunity_information_form.finish_date_minute }}
                {{ opportunity_information_form.finish_date_meridiems }}
            </li>
            <li>Opportunity Stage: {{ opportunity_information_form.opportunity_stage_id }}</li>
            <li>Opportunity Success Probability: {{ opportunity_information_form.opportunity_success_probability }}</li>
            <li>
                <input type="submit" name="submit_contact" value="Update"/>
                {% if opportunity_results.opportunity_stage_id.opportunity_closed == "TRUE" and opportunity_perm == 4 %}
                    <a href="javascript:void(0)" onclick="reopen_temp()">Reopen</a>
                {% endif %}
            </li>
        </ul>
    </form>

    <h2>To Do</h2>
    <form id="to_do">
        Loading...
    </form>

    <div id="email_history">
        <h2>Email History</h2>
        Loading...
    </div>

    <h2>Associated Projects & Tasks</h2>
    <ul>
    {% if opportunity_results.opportunity_stage_id.opportunity_closed != "TRUE" %}
        <li><a href="{% url 'new_project' opportunity_id 'opportunity'%}">Create New Project</a></li>
        <li><a href="{% url 'new_task' opportunity_id 'opportunity' %}">Create New Task</a></li>
    {% endif %}
    </ul>
    <h2>Assigned Projects</h2>
    {% if project_results %}
        <table>
            <tr class="header">
                <td>Project ID</td>
                <td>Project Name</td>
                <td>Project End Date</td>
                <td>Project Status</td>
            </tr>
            {% for row in project_results %}
                <tr>
                    <td><a href="#">PRO{{ row.project_id.project_id }}</a></td>
                    <td>{{ row.project_id.project_name }}</td>
                    <td>{{ row.project_id.project_end_date }}</td>
                    <td>{{ row.project_id.project_status }}</td>
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>There are no associated projects. Please create a new project</p>
    {% endif %}
    <br/>
    <h2>Assigned Tasks</h2>
    {% if tasks_results %}
        <table>
            <tr class="header">
                <td>Task ID</td>
                <td>Project Name</td>
                <td>Project End Date</td>
                <td>Project Status</td>
            </tr>
            {% for row in tasks_results %}
                <tr>
                    <td><a href="#">TASK{{ row.tasks_id.tasks_id }}</a></td>
                    <td>{{ row.tasks_id.task_short_description }}</td>
                    <td>{{ row.tasks_id.task_end_date }}</td>
                    <td>{{ row.tasks_id.task_status }}</td>
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>There are no associated tasks. Please create a new task</p>
    {% endif %}

    <h2>Opportunity Quotes</h2>
    {% if opportunity_results.opportunity_stage_id.opportunity_closed != "TRUE" %}
        <a href="{% url 'new_quote' opportunity_id 'opportunity' %}">New Quote</a>
    {% endif %}
    {% if quote_results %}
        <table>
            <tr>
                <td width="50%">Quote Title</td>
                <td width="25%">Valid Till</td>
                <td width="25%">Quote Stage</td>
            </tr>
            {% for row in quote_results %}
                <tr>
                    <td><a href="{% url 'quote_information' row.quote_id %}">{{ row.quote_title }}</a></td>
                    <td>{{ row.quote_valid_till }}</td>
                    <td>{{ row.quote_stage_id }}</td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}

{% if opportunity_results.opportunity_stage_id.opportunity_closed != "TRUE" %}
    <h2>Opportunity Permissions</h2>
    <p>Please note - if there are NO permissions added to an opportunity then everyone will have access to the
        opportunity</p>
    <form id="group_permissions">
        <h3>Group Permissions</h3>
        Loading...
    </form>


    <form id="user_permissions">
        <h3>User Permissions</h3>
        Loading...
    </form>

{% endif %}
    <script type="text/javascript" src="{% static 'NearBeach/javascript/chosen-js/chosen.jquery.js' %}"></script>
    <script type="text/javascript" src="{% static 'NearBeach/javascript/chosen-js/docsupport/prism.js' %}"></script>
    <script type="text/javascript" src="{% static 'NearBeach/javascript/chosen-js/docsupport/init.js' %}"></script>
<div name="blank_space" style="margin-bottom: 150px;"></div>
<script>
    $("#to_do").on('submit', function(e){
       e.preventDefault();
       $.ajax({
           url: '/to_do/{{ opportunity_id }}/opportunity/',
           data: $(this).serialize(),
           type: "POST",
           success: function(data) {
               $("#to_do").html(data);
           },
           error: function() {
               alert("Sorry, something went wrong with the TO DO");
           }
       })
    });

    $("#group_permissions").on('submit', function(e){
        e.preventDefault();
        $.ajax({
           url: '/opportunity_information/opportunity_group_permission/{{ opportunity_id }}/',
           data: $(this).serialize(),
           type: "POST",
           success: function(data) {
               $("#group_permissions").html(data);
           },
           error: function() {
               alert("Sorry, something went wrong with the group permissions");
           }
        })
    });

    $("#opportunity_information").on('submit', function(e) {
        //State the save_state is currently saving
        $("#save_state").html("Currently Saving Project");

        //Grab which button was pressed
        var which_button = $("input[type=submit][clicked=true]").val()

        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '/opportunity_information/{{ opportunity_id }}/',
            data: $(this).serialize(),
            success: function() {
                //State that the function has saved
                var current_time = Date();
                $("#save_state").html("Saved last on " + current_time);
            },
            error: function() {
                alert("Sorry, project information did not save. Please try again.");
            }
        })
    });

    $("#user_permissions").on('submit', function(e){
        e.preventDefault();
        $.ajax({
            url: '/opportunity_information/opportunity_user_permission/{{ opportunity_id }}/',
            data: $(this).serialize(),
            type: "POST",
            success: function(data) {
                $("#user_permissions").html(data);
            },
            error: function() {
                alert("Sorry, something went wrong with the user permisions");
            }
        })
    })

    function complete_to_do(to_do_id) {
        //Send data to the database
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $.ajax({
            url: '/to_do_complete/' + to_do_id + '/',
            data: {},
            type: "POST",
            success: function(data) {
                load_to_do();
            },
            error: function() {
                alert("Can not complete To do :(");
            }
        });
    }

    function reopen_temp() {
        $("input").prop("readonly", false);

        //Enable all the select statements
        $("select").prop("disabled", false);

        //Disable all text area
        $("textarea").prop("disabled", false);

        //Disable all the buttons.
        $("input[type=submit]").prop("disabled", false);
    };

    function on_page_load() {
        /*
        If the opportunity_stage_id has the field opportunity_closed == TRUE, we want
        to turn this opportunity into a read only. As it can not longer be edited.
         */
        if ("{{ opportunity_results.opportunity_stage_id.opportunity_closed }}" == "TRUE") {
            set_permissions(1); //Read only
        } else {
            set_permissions({{ opportunity_perm }});
        }

        load_to_do();
        load_group_permissions();
        load_user_permissions();
        load_email_history();
    }

    function load_email_history() {
        $.ajax({
            url: '/email_history/{{ opportunity_id }}/opportunity',
            data: {},
            dataType: 'HTML',
            type: 'GET',
            success: function(data) {
                $("#email_history").html(data);
            },
            error: function() {
                alert("Sorry, the email history could not load");
            }
        })
    };

    function load_to_do() {
        $.ajax({
            url: '/to_do/{{ opportunity_id }}/opportunity/',
            data: {},
            type: "GET",
            datatype: "HTML",
            success: function (data) {
                $("#to_do").html(data);
            },
            error: function() {
                alert("Sorry, could not load the TO DO list");
            },
        });
    }

    function load_group_permissions() {
        $.ajax({
            url: '/opportunity_information/opportunity_group_permission/{{ opportunity_id }}/',
            data: {},
            type: "GET",
            datatype: "HTML",
            success: function(data) {
                $("#group_permissions").html(data);
            },
            error: function() {
                alert("Sorry, could not load group permissions");
            },
        })
    }

    function load_user_permissions() {
        $.ajax({
            url: '/opportunity_information/opportunity_user_permission/{{ opportunity_id }}/',
            data: {},
            type: "GET",
            datatype: "HTML",
            success: function(data) {
                $("#user_permissions").html(data);
            },
            error: function() {
                alert("Sorry, could not load user permissions");
            },
        })
    }

    function delete_permission(opportunity_permissions_id) {
        //Send data to the database
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $.ajax({
            url: '/opportunity_information/opportunity_delete_permission/' + opportunity_permissions_id + '/',
            data: {},
            type: "POST",
            datatype: "HTML",
            success: function(data) {
                load_group_permissions();
                load_user_permissions();
            },
            error: function() {
                alert("There was an error removing that permission");
            }
        })
    }
</script>
</body>
{% endblock %}