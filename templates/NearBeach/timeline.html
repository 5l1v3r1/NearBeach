{% extends "./template.html" %}
{% block content %}
{% load static %}
    <style>
        svg {
           overflow-x: scroll;
        }

        .chart {
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        .axis path,.axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        .bar {
            fill: #33b5e5;
        }

        .bar-failed {
            fill: #CC0000;
        }

        .bar-running {
            fill: #669900;
        }

        .bar-succeeded {
            fill: #33b5e5;
        }

        .bar-killed {
            fill: #ffbb33;
        }
    </style>
    <script src="{% static 'NearBeach/widgets/svg.js/svg.js' %}"></script>
    <script src="{% static 'NearBeach/widgets/jquery/jquery-ui.js' %}"></script>
    <link rel="stylesheet" href="{% static 'NearBeach/widgets/jquery/jquery-ui.css' %}">

    <!--
    Due to a bug in d3_gnatt_chart - https://github.com/dk8996/Gantt-Chart/issues/27
    We have to utilise an older version of D3. This version of D3 is only used here in the timeline.
    Newer versions of D3 are utilised everywhere else
    -->
    <script type="text/javascript" src="{% static 'NearBeach/widgets/d3_gnatt_chart/lib/d3/d3.v3.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'NearBeach/widgets/d3_gnatt_chart/gantt-chart-d3.js' %}"></script>



    <h2>Timeline</h2>
    <form id="date_form">
    {% csrf_token %}
        <ul>
            <li>Start Date: {{ timeline_form.start_date }}</li>
            <li>End Date:{{ timeline_form.end_date }}</li>
        </ul>
    </form>

    <br/>
    <div id="timeline" style="width: 100%; overflow: auto;"></div>

    <script>
        const month_names = ["January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];

        $( "#id_start_date" ).datepicker({
            dateFormat: "yy-mm-dd"
        });
        $( "#id_start_date" ).val("{{ start_date|date:'Y-m-d' }}");
        //$("#id_start_date").setDate("{{ start_date }}");
        $("#id_end_date").datepicker({
            dateFormat: "yy-mm-dd"
        });
        $("#id_end_date").val("{{ end_date|date:'Y-m-d' }}");

        /*
        TEMP CODE
        ~~~~~~~~~
        The following code will help create a gnantt chart. Hopefully.

        Method
        ~~~~~~
        1.) Extract the project information from NearBeach using AJAX
        2.) Information comes in an AJAX form
        3.) Collect the variables, i.e. start and end dates
        4.) Create the chart by inputting the variables
         */

        var taskStatus = {
            "SUCCEEDED" : "bar",
            "FAILED" : "bar-failed",
            "RUNNING" : "bar-running",
            "KILLED" : "bar-killed"
        };

        var tasks = [
            {
                "startDate":new Date("Sun Dec 09 00:00:00 EST 2012"),
                "endDate":new Date("Sun Dec 12 23:59:59 EST 2012"),
                "taskName":"E Job",
                "status":"RUNNING"
            }
        ];

        var taskNames = [
            "Pro1",
            "P Job",
            "E Job",
            "A Job",
            "N Job"
        ];

        /*
        NO NEED TO SORT AS DJANGO WILL DO THIS FOR US
        tasks.sort(function(a, b) {
            return a.endDate - b.endDate;
        });*/

        //var maxDate = tasks[tasks.length - 1].endDate;



        var gantt = d3.gantt()
            .taskTypes(taskNames)
            .taskStatus(taskStatus)
            .tickFormat(format)
            .height(450)
            .width(1600) //WILL BE FORMULA DEPENDING ON HOW MANY DAYS THERE ARE BETWEEN START AND END DATES
            .selector("#timeline");



        gantt.timeDomainMode("fixed");
        //gantt.timeDomain([ d3.time.day.offset(getEndDate(), -7), getEndDate() ]);
        gantt.timeDomain([
            new Date(document.getElementById("id_start_date").value),
            new Date(document.getElementById("id_end_date").value)
        ]);

        var format = "%b %d, %Y"; //HARD CODED
        gantt.tickFormat(format);

        gantt.redraw(tasks);



        gantt(tasks);
    </script>

{% endblock %}

