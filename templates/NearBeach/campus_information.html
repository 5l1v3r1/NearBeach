{% extends "./template.html" %}
{% block content %}
{% load static %}

<script type="text/javascript" src="{% static 'NearBeach/javascript/campus_information.js' %}"></script>
<script type="text/javascript" src="{% static 'NearBeach/javascript/permissions.js' %}"></script>

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
<script type="text/javascript" src="{% static 'NearBeach/javascript/jquery/jquery-3.2.1.min.js' %}"></script>

<body onload="on_page_load('{{ campus_results.campus_country_id_id }}', '{{ campus_results.campus_region_id }}')">
	<h2>Campus Information - {{ campus_results.campus_nickname }}</h2>
	<form action="{% url 'campus_information' campus_results.organisations_campus_id %}" method="post" class="campus_information">
		{% csrf_token %}
		<ul>
			<li><a href="{% url 'organisation_information' campus_results.organisations_id.organisations_id %}">{{ campus_results.organisations_id }}</a></li>
			<li>{{ campus_information_form.campus_nickname }}</li>
			<li>{{ campus_information_form.campus_phone }}</li>
			<li>{{ campus_information_form.campus_fax }}</li>
			<li>{{ campus_information_form.campus_address1 }}</li>
			<li>{{ campus_information_form.campus_address2 }}</li>
			<li>{{ campus_information_form.campus_address3 }}</li>
			<li>{{ campus_information_form.campus_suburb }}</li>
			<li>
				Country:
				<select id="campus_country_id" name="campus_country_id" onchange="country_changed()" required="True">
					<option value="---------" selected disabled="disabled">---------</option>
					{% for row in countries_results %}
						<option value="{{ row.country_id }}">{{ row.country_name }}</option>
					{% endfor %}
				</select>
			</li>
			<li>
				Region:
				<select id="campus_region_id" name="campus_region_id" required="True">
					<option value="---------" selected disabled="disabled">---------</option>
					{% for row in countries_regions_results %}
						<option value="{{ row.region_id }}" country_id="{{ row.country_id_id }}">{{ row.region_name }}</option>
					{% endfor %}
				</select>
			</li>
		</ul>
		<input type="submit" value="Save">
	</form>
	<h2>Campus Contacts</h2>
	{% if add_customers_results %}
		<form action="{% url 'campus_information' campus_results.organisations_campus_id %}" method="POST" class="campus_information">
			{% csrf_token %}
			<select name="add_customer_select" id="id_add_customer_select" onchange="enable_disable_add_customer()">
				<option value="---------"> ---------</option>
				{% for row in add_customers_results %}
					<option value="{{ row.customer_id }}">{{ row.customer_first_name }} {{ row.customer_last_name }}</option>
				{% endfor %}
			</select>
			<input type="submit" name="add_customer_submit" value="Add Customer" disabled id="id_add_customer_submit">
		</form>
	{% endif %}
	<br/>
	{% if customer_campus_results %}
		<table>
			<tr class="header"><td>First Name</td><td>Last Name</td><td>Email</td><td>Phone</td><td>Fax</td><td>Delete</td></tr>
			{% for row in customer_campus_results %}
				<tr>
					<td><a href="{% url 'customers_campus_information' row.customers_campus_id 'CAMP' %}">{{ row.customer_id.customer_first_name }}</a></td>
					<td>{{ row.customer_id.customer_last_name }}</td>
					<td>{{ row.customer_id.customer_email }}</td>
					<td>{{ row.customer_phone }}</td>
					<td>{{ row.customer_fax }}</td>
					<td><a href="{% url 'delete_campus_contact' row.customers_campus_id 'CAMP' %}">Delete</a></td>
				</tr>
			{% endfor %}
		</table>
	{% else %}
		<p>There are no customers at this campus</p>
	{% endif %}
	<h2>Map</h2>
	<div id='map'></div>

    <div id="google_map"></div>
    <script>
        //{lat: -25.363, lng: 131.044}
        //{lat: 144.9633333300000, lng: -37.8077777800000}
        //{lat: 144.963, lng: -37.807}
      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 144.363, lng: -37.044},
          zoom: 8
        });
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAP_API_TOKEN }}&callback=initMap" async defer></script>

	<script type="text/javascript">
        function on_page_load(country, region) {
            {% if not MAPBOX_API_TOKEN == '' %}
            /* Information
             * ~~~~~~~~~~~
             * The following will setup the page correctly. We want the ability for the country and region to be selected
             * correctly, and any options under the region that should not be appearing will be disabled. The disabled
             * will disappear through CSS manipulation.
             */
            var campus_country_select = document.getElementById("campus_country_id").getElementsByTagName("option");
            var campus_region_select = document.getElementById("campus_region_id").getElementsByTagName("option");


            //Select the correct country
            for (var i=0; i<campus_country_select.length; i++) {
                //Select country if it is the correct one and then break out of the loop
                if (campus_country_select[i].value.toLowerCase() == country.toLowerCase()) {
                    document.getElementById("campus_country_id").selectedIndex = i;
                    break;
                }
            }

            //Select the correct region, and disable all others
            for (var i=1; i<campus_region_select.length; i++) {
                //Select region if it is the correct one
                if (campus_region_select[i].text.toLowerCase() == region.toLowerCase()) {
                    document.getElementById("campus_region_id").selectedIndex = i;
                }

                //Enable or disable region due to country
                var country_id = campus_region_select[i].getAttribute("country_id");
                if (country_id.toLowerCase() == country.toLowerCase()) {
                    campus_region_select[i].disabled = false;
                } else {
                    campus_region_select[i].disabled = true;
                }
            }

            set_permissions({{ permission }});


            mapboxgl.accessToken  = "{{ MAPBOX_API_TOKEN }}";
            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/mapbox/streets-v9', // stylesheet location
                center: [{{ campus_results.campus_longitude }},{{ campus_results.campus_latitude }}], // starting position [lng, lat]
                zoom: 15 // starting zoom
            });
            map.on('load', function() {
                map.addLayer({
                    "id": "points",
                    "type": "symbol",
                    "source": {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": [{
                                "type": "Feature",
                                "geometry": {
                                    "type": "Point",
                                    "coordinates": [{{ campus_results.campus_longitude }},{{ campus_results.campus_latitude }}]
                                },
                                "properties": {
                                    "title": "{{ campus_results.campus_nickname }}",
                                    "icon": "marker"
                                }
                            }]
                        }
                    },
                    "layout": {
                        "icon-image": "{icon}-15",
                        "text-field": "{title}",
                        "text-font": ["Open Sans Semibold", "Arial Unicode MS Bold"],
                        "text-offset": [0, 0.6],
                        "text-anchor": "top"
                    }
                })

            });

            //Quickly, relayout the map before anyone knows
            //relayout_map();
            setTimeout(relayout_map, 500);
            {% endif %}

        }
	</script>

</body>
{% endblock %}
