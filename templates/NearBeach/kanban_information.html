{% extends "./template.html" %}
{% block content %}
{% load nearbeach_extras %}
{% load static %}
<script type="text/javascript" src="{% static 'NearBeach/javascript/csrf_finder.js' %}"></script>
    <style>
    /*TEMP STYLE*/
    .kanban_column_header {
        background-color:#52460a;
        text-align:center;
        color:white;
        padding: 2px 0px;
        min-width: 300px;
    }

    .kanban_level {
        min-height: 100px;
    }

    *[draggable=true]
    {
        float:left;
        min-width: 90%;
        min-height: 50px;
        border: 2px solid black;
        margin: 10px;
        font-weight:bold;
        min-height:60px;
        background-image: -webkit-gradient(
            linear,
            left top, left bottom,
            color-stop(0.63, white),
            color-stop(0.92, rgb(5,161,245)));
            background-image:-moz-linear-gradient(
            center top,
            white 63%,
            rgb(5,161,245) 92%
        );
        -webkit-background-size:1px 8px;
        -moz-background-size:1px 8px;
        background-size:1px 8px;
        background-repeat:repeat;
    }
    .cardTitle
    {
        background-color: rgb(255,255,255);
        border:2px solid white;
    }
    </style>

    <h2>Kanban Table</h2>
    <table>
        {% for level in kanban_level_results %}
            {% if forloop.counter0 == 0 %}
                <tr>
                    {% for column in kanban_column_results %}
                        <td class="kanban_column_header">{{ column.kanban_column_name }}</td>
                    {% endfor %}
                </tr>
            {% endif %}

            {% with level_cards=kanban_card_results|filter_level_cards:level.kanban_level_id %}
                <tr class="kanban_level">
                    {% for column in kanban_column_results %}
                        <td class="kanban_column" data-column="{{ column.kanban_column_id }}" data-level="{{ level.kanban_level_id }}">
                            {% with column_cards=level_cards|filter_column_cards:column.kanban_column_id %}
                                {% for row in column_cards %}
                                    <div id="{{ row.kanban_card_id }}" class="kanban_card" draggable="true">
                                        <div class="cardTitle">
                                            {{ row.kanban_card_text }}
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endwith %}
                        </td>
                    {% endfor %}

                </tr>
            {% endwith %}
        {% endfor %}
    </table>

    <script type="text/javascript">
		$('document').ready(on_page_load());

        function on_page_load(){
            $('.kanban_card').bind('dragstart', function(event) {
                event.originalEvent.dataTransfer.setData("text/plain", event.target.getAttribute('id'));
            });

  		    // bind the dragover event on the board sections
            $('.kanban_column').bind('dragover', function(event) {
                event.preventDefault();
            });

			// bind the drop event on the board sections
  			$('.kanban_column').bind('drop', function(event) {
                var kanban_card_id = event.originalEvent.dataTransfer.getData("text/plain");
                event.target.appendChild(document.getElementById(kanban_card_id));
                event.preventDefault();

                //Send data to the database
                $.ajaxSetup({
                    beforeSend: function (xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });



                $.ajax({
                    url: '/kanban_move_card/' + document.getElementById(kanban_card_id).id + '/' + this.dataset.column + '/' + this.dataset.level + '/',
                    data: {},
                    dataType: 'HTML',
                    type: 'POST',
                    success: function (data) {
                    },
                    error: function(request, error) {
                        alert("We are sorry. Something went wrong when we moved that card. Reloading page");
                        location.reload()
                    }
                })
			});
        }
    </script>
{% endblock %}