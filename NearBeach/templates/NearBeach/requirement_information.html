{% extends "./template.html" %}
{% block content %}
{% load static %}
<body onload="on_page_load()">
    <script type="text/javascript" src="{% static 'NearBeach/javascript/permissions.js' %}"></script>
    <script type="text/javascript" src="{% static 'NearBeach/javascript/bug.js' %}"></script>

    <div class="card mt-4">
        <div class="card-header">
            <h1>Requirement Information - {{ requirement_id }}</h2>
        </div>
        <div class="card-body">
            <form id="requirement_information" name="requirement_information" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                {{ requirement_information_form.media }}
                <div class="form-group">
                    <label for="id_requirement_title">Requirement Title</label>
                    {{ requirement_information_form.requirement_title }}
                </div>
                <div class="form-group">
                    <label for="id_requirement_scope">Requirement Scope</label>
                    {{ requirement_information_form.requirement_scope }}
                </div>

                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="id_requirement_type">Requirement Type</label>
                        {{ requirement_information_form.requirement_type }}
                    </div>
                    <div class="form-group col-md-6">
                        <label for="id_requirement_status">Requirement Status</label>
                        {{ requirement_information_form.requirement_status }}
                    </div>
                </div>
                <input type="submit" value="Update" class="btn btn-primary col-md-12">
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h2>Requirement Items</h2>
        </div>
        <div class="card-body">
            <a href="{% url 'new_requirement_item' requirement_id %}">Create Requirement Item</a>
            {% if requirement_item_results %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <td>Requirement Item</td>
                            <td>Requirement Description</td>
                        </tr>
                    </thead>
                    {% for item in requirement_item_results %}
                        <tr>
                            <td><a href="javascript:void(0)">ITM{{ item.requirement_item_id }}</a></td>
                            <td>{{ item.requirement_item_title }}</td>
                        </tr>
                    {% endfor %}
                </table>
            {% endif %}
        </div>
    </div>


    <h2>Requirement Items</h2>

    <form method="POST" class="requirement_items_list" id="requirement_items_list">
        Loading Table...
    </form>

    {% if permission > 2 %}
        <a href="javascript:void(0)" onclick="new_requirement_item()">New Requirement Item</a>
    {% endif %}

    <form method="POST" class="new_requirement_item" id="new_requirement_item" style="background-color: #b0cfe0;">
    <!-- BLANK - will populate when needed using AJAX -->
    </form>

    <div method="POST" class="edit_requirement_item" id="edit_requirement_item_div" style="background-color: azure;">
        <form method="POST" class="edit_requirement_item" id="edit_requirement_item">
            <!-- BLANK - will populate when needed using AJAX -->
        </form>
        <div id="requirement_item_documents">
            <!-- BLANK - will populate when needed using AJAX -->
        </div>
    </div>


    <form method="POST" class="requirement_links_list" id="requirement_links_list">
        <h2>Requirement Links</h2>
        Loading...
    </form>

    <form method="POST" class="requirement_new_link" id="requirement_new_link" style="background-color: palevioletred">
        {% if requirement_link_permissions > 2 %}
            <a href="javascript:void(0)" onclick="link_requirement({{ requirement_id }})">Link Current Requirement</a>
        {% endif %}
    </form>


    <div id="requirement_documents">
        <h2>Requirement Documents</h2>
        Loading...
    </div>

    <form method="post" class="bug_list" id="bug_list">
        <h2>Requirement Bug List</h2>
        Loading...
    </form>

    <form method="post" class="bug_search" id="bug_search">
        <h2>Bug Search</h2>
        Loading...
    </form>

    <form action="POST" id="tag_results" class="tag_results">
        <div class="card mt-4">
            <div class="card-header">
                <h2>Tags</h2>
            </div>
            <div class="card-body">
                Loading...
            </div>
        </div>
    </form>

    {% if permission >= 3 %}
        <form method="post" class="requirement_assigned_users" id="requirement_assigned_users">
            <h2>Assigned Users</h2>
            Loading...
        </form>
        <div id="assigned_user_list">Loading list...</div>

        <h2>Assigned Groups</h2>
        <form method="post" class="requirement_assigned_groups" id="requirement_assigned_groups">
            Loading add...
        </form>
        <div id="assigned_group_list">Loading list...</div>
    {% endif %}

    <h2>Requirement Linked to Kanban Board</h2>
    {% if kanban_board_results %}
        <table>
            <tr><td>Kanban Board Name</td></tr>
            {% for row in kanban_board_results %}
                <tr><td>
                    <a href="{% url 'kanban_requirement_information' row.kanban_board_id %}">{{ row.kanban_board_name }}</a>
                </td></tr>
            {% endfor %}
        </table>
    {% else %}
        <table>
            <tr>
                <td><a href="{% url 'new_kanban_requirement_board' requirement_results.requirement_id %}">Click here to create kanban link</a> </td>
            </tr>
        </table>
    {% endif %}

    <script>
        $("#bug_search").on('submit', function(e) {
           e.preventDefault();

           //Change the submit button for user feedback
           $("#bug_search_submit").prop("disabled",true);
           $("#bug_search_submit").val("SEARCHING...");


           $.ajax({
               type: 'POST',
               url: '/bug_search/{{ requirement_id }}/requirement/',
               data: $(this).serialize(),
               success: function(data) {
                   $("#bug_search").html(data);
               },
               error: function() {
                   alert("Sorry, submitting the bug search caused an error");
               }
           })
        });

        $("#new_requirement_item").on('submit', function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/requirement_items_new/{{ requirement_id }}/',
                data: $(this).serialize(),
                success: function() {
                    //Reload the project history :)
                    $("#new_requirement_item").html("");
                    //load_requirement_items_list();

                },
                error: function() {
                    alert("Sorry, new requirement item did not save. Please try again.");
                }
            })
        });

        $("#edit_requirement_item").on('submit', function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '/requirement_item_edit/' + $("#requirement_item_id").val() + '/',
                data: $(this).serialize(),
                success: function() {
                    //Reload the project history :)
                    $("#edit_requirement_item").html("");
                    //load_requirement_items_list();

                },
                error: function() {
                    alert("Sorry, new requirement item did not save. Please try again.");
                }
            })
        });

    $("#requirement_assigned_users").on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '/assigned_user_add/{{ requirement_id }}/requirement/',
            data: $(this).serialize(),
            success: function() {
                load_assigned_user_list();
                load_assigned_user_add();
            },
            error: function() {
                alert("Sorry, project assigned users did not save. Please try again.");
            }
        })
    });


    $("#requirement_assigned_groups").on('submit', function(e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '/assigned_group_add/{{ requirement_id }}/requirement/',
            data: $(this).serialize(),
            success: function() {
                load_assigned_group_list();
                load_assigned_group_add();
            },
            error: function() {
                alert("Sorry, project assigned users did not save. Please try again.");
            }
        })
    });

    $("#tag_results").on('submit', function(e) {
       e.preventDefault();

       $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

       $.ajax({
           url: '/tag_information/{{ requirement_id }}/requirement/',
           data: $(this).serialize(),
           dataType: 'HTML',
           type: 'POST',
           success: function(data) {
               $("#tag_results").html(data);
           },
           error: function() {
               alert("Sorry, could not save tag.");
           },
       })
    });


        function load_bug_list() {
        $.ajax({
            url: '/bug_list/{{ requirement_id }}/requirement',
            data: {},
            dataType: 'HTML',
            type: 'GET',
            success: function(data) {
                $("#bug_list").html(data);
            },
            error: function() {
                alert("There was an issue loading the bug list");
            }
        })
    }


    function load_bug_search() {
        $.ajax({
            url: '/bug_search/{{ requirement_id }}/requirement',
            data: {},
            dataType: 'HTML',
            type: 'GET',
            success: function(data) {
                $("#bug_search").html(data);
            },
            error: function() {
                alert("There was an issues loading the bug search");
            }
        })

    }



        function load_requirement_documents() {
            //Get the requirement documents
            $.ajax({
                url: '/requirement_documents_uploads/{{ requirement_id }}/requirement/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#requirement_documents").html(data);
                },
                error: function() {
                    alert("Sorry, the requirement documents could not load for some strange reason.")
                }
            })
        }

        function load_requirement_item_documents(requirement_item_id) {
            //Get the requirement documents
            $.ajax({
                url: '/requirement_documents_uploads/' + requirement_item_id + '/requirement_item/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#requirement_item_documents").html(data);
                },
                error: function() {
                    alert("Sorry, the requirement documents could not load for some strange reason.")
                }
            })
        }

        function load_assigned_group_add() {
            $.ajax({
                url: '/assigned_group_add/{{ requirement_id }}/requirement/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $('#requirement_assigned_groups').html(data);
                },
                error: function() {
                    $('#requirement_assigned_groups').html('<h2>Assigned Groups</h2>Sorry, assigned groups encounted an error and did not load.');
                }
            });
        };


        function load_assigned_group_list() {
            $.ajax({
                url: '/assigned_group_list/{{ requirement_id }}/requirement/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $('#assigned_group_list').html(data);
                },
                error: function() {
                    $('#assigned_group_list').html('<h2>Assigned Groups</h2>Sorry, assigned groups encounted an error and did not load.');
                }
            });
        };

        function load_assigned_user_add() {
            $.ajax({
                url: '/assigned_user_add/{{ requirement_id }}/requirement/',
                data:  {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#requirement_assigned_users").html(data);
                },
                error: function() {
                    $("#requirement_assigned_users").html("<h2>Assigned Users</h2>Sorry, users encounted an error and did not load");
                }
            })
        };

        function load_assigned_user_list() {
            $.ajax({
                url: '/assigned_user_list/{{ requirement_id }}/requirement/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#assigned_user_list").html(data);
                },
                error: function(data) {
                    $("#assigned_user_list").html("<p>User list failed to load</p>")
                }
            })
        }


        function link_requirement(requirement_id) {
            $.ajax({
                url: '/requirement_new_link/' + requirement_id + '/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#requirement_new_link").html(data);

                    //Scroll into view
                    var offset = $("#requirement_new_link").offset;
                    $('html, body').animate({scrollTop: offset.top});
                },
                error: function() {
                    $("#requirement_new_link").html("<h2>New Requirement</h2>Sorry, new requirement encounted an error and did not load");
                }
            })
        }


        function link_requirement_item(requirement_item_id) {
            $.ajax({
                url: '/requirement_items_new_link/' + requirement_item_id + '/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#requirement_item_new_link").html(data);

                    //Scroll into view
                    var offset = $("#requirement_item_new_link").offset;
                    $('html, body').animate({scrollTop: offset.top});
                },
                error: function() {
                    $("#requirement_item_new_link").html("<h2>New Requirement Item</h2>Sorry, new requirement item encounted an error and did not load");
                }
            })
        }


        function new_requirement_item() {
            //New Requirement Item
            $.ajax({
                url: '/requirement_items_new/{{ requirement_id }}',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#new_requirement_item").html(data);

                    //Scroll into view
                    var offset = $("#new_requirement_item").offset;
                    $('html, body').animate({scrollTop: offset.top});
                },
                error: function() {
                    $("#new_requirement_item").html("<h2>New Requirement Item</h2>Sorry, new requirement item encounted an error and did not load");
                }
            })

        }

        function edit_requirement_item(requirement_item_id) {
            //New Requirement Item
            $.ajax({
                url: '/requirement_item_edit/' + requirement_item_id + '/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#edit_requirement_item").html(data);

                    //Scroll to the item
                    var offset = $("#edit_requirement_item").offset();
                    $('html, body').animate({
                        scrollTop: offset.top - 150,

                    });
                    set_permissions({{ permission }});
                    load_requirement_item_documents(requirement_item_id);

                },
                error: function() {
                    $("#edit_requirement_item").html("<h2>Edit Requirement Item</h2>Sorry, edit requirement item encounted an error and did not load");
                }
            })

        }

        function delete_group_item(group_item) {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            $.ajax({
                url: '/assigned_group_delete/' + group_item + '/',
                data: {},
                dataType: 'HTML',
                type: 'POST',
                success: function(data) {
                    load_assigned_group_list();
                    load_assigned_group_add();
                },
                error: function() {
                    alert("Sorry, there was an issue deleting the Assigned Group")
                }
            });
        };


        function send_requirement_link(requirement_id, location_id, task_or_project) {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            alert("Requirement ID: " + requirement_id + "\nLocation ID: " + location_id + "\nTask or Project: " + task_or_project);

            $.ajax({
                url: '/requirement_new_link/' + requirement_id + '/' + location_id + '/' + task_or_project + '/',
                data: {},
                dataType: 'HTML',
                type: 'POST',
                success: function (data) {
                    //RELOAD STUFF
                    $("#requirement_new_link").html('<a href="javascript:void(0)" onclick="link_requirement(' + requirement_id + ')">Link Current Requirement</a>');
                    requirement_links_list();
                },
                error: function(request, error) {
                    alert("Sorry, could not link requirement. Please try again soon. This is because of: \n" + error + "\n\nREQUEST\n" + request)
                }
            })
        }


        function send_requirement_item_link(requirement_item_id, location_id, task_or_project) {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            $.ajax({
                url: '/requirement_items_new_link/' + requirement_item_id + '/' + location_id + '/' + task_or_project + '/',
                data: {},
                dataType: 'HTML',
                type: 'POST',
                success: function (data) {
                    //RELOAD STUFF
                    $("#requirement_item_new_link").html('<a href="javascript:void(0)" onclick="link_requirement_item(' + requirement_item_id + ')">Link Requirement Item</a>');
                    requirement_links_list();
                },
                error: function() {
                    alert("Sorry, could not link requirement item. Please try again soon.")
                }
            })
        }

        function requirement_links_list() {
            //New Requirement Item
            $.ajax({
                url: '/requirement_links_list/{{ requirement_id }}',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#requirement_links_list").html(data);

                },
                error: function() {
                    $("#requirement_links_list").html("<h2>Edit Requirement Links</h2>Sorry, edit requirement links encounted an error and did not load");
                }
            })

        }

        function on_page_load() {
            //Load all ajax modules
            load_assigned_group_list();
            load_assigned_group_add();
            load_assigned_user_list();
            load_assigned_user_add();
            //load_requirement_items_list();
            requirement_links_list();
            load_requirement_documents();
            load_bug_search();
            load_bug_list();


            set_permissions({{ permission }})
        }

        function close_new_requirement_item() {
            $("#new_requirement_item").html("");
        }


        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        // using jQuery to extract the CSRFToken
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');


        function load_tag_results() {
            $.ajax({
                url: '/tag_information/{{ requirement_id }}/requirement/',
                data: {},
                dataType: 'HTML',
                type: 'GET',
                success: function(data) {
                    $("#tag_results").html(data);
                },
                error: function() {
                    alert("Sorry - tag results did not load");
                }
            });
        }

        function delete_tag(tag_id) {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });

            $.ajax({
                url: '/delete_tag_from_object/' + tag_id + '/{{ requirement_id }}/requirement/',
                data: {},
                dataType: 'HTML',
                type: 'POST',
                success: function(data) {
                    load_tag_results();
                },
                error: function() {
                    alert("Sorry - did not delete tag correctly");
                }
            });
        }
    </script>

</body>
{% endblock %}